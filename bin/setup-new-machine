#!/bin/bash

MYRC_DIR="$HOME/SparkleShare/github.com/myrc/"

SYSTEM_PKGS="zsh fasd fzf git nvim ctags tmux"
APPS_PKGS=""

function backpath() {
  if [ -f $1 ] || [ -f $1 ]; then
    mv $1 $1.bak
  fi
}

function symlink() {
  backpath $2
  ln -sf $1 $2
}

function install_rcs() {
  echo " * Install RC files..."

  symlink $MYRC_DIR/gitconfig $HOME/.gitconfig
  symlink $MYRC_DIR/gitignore $HOME/.gitignore

  symlink $MYRC_DIR/zshrc $HOME/.zshrc
  symlink $MYRC_DIR/zimrc $HOME/.zimrc
  symlink $MYRC_DIR/zlogin $HOME/.zlogin

  symlink $MYRC_DIR/tmux.conf $HOME/.tmux.conf
}

function install_bin() {
  echo " * Install Bin dir..."

  symlink $MYRC_DIR/bin $HOME/bin
  chmod +x $HOME/bin/*
}

function install_pkgs() {
  sudo dnf install ${SYSTEM_PKGS} ${APPS_PKGS}
}

function install_zim() {
  if [ -d $HOME/.zim ]; then
    echo " * Update zsh fw Zim..."
    cd $HOME/.zim
    git pull
  else
    echo " * Install zsh fw Zim..."
    git clone --recursive https://github.com/zimfw/zimfw.git ${ZDOTDIR:-${HOME}}/.zim

    setopt EXTENDED_GLOB
    for template_file in ${ZDOTDIR:-${HOME}}/.zim/templates/*; do
      user_file="${ZDOTDIR:-${HOME}}/.${template_file:t}"
      touch ${user_file}
      ( print -rn "$(<${template_file})$(<${user_file})" >! ${user_file} ) 2>/dev/null
    done

    chsh -s =zsh
  fi
}

function install_rbenv() {
  if [ -d $HOME/.rbenv ]; then
    echo " * Update rbenv..."
    cd ~/.rbenv && git pull
    cd ~/.rbenv/plugins
    for p in `ls` ; do
      cd $p && git pull && cd ..
    done
  else
    echo " * Install rbenv..."
    git clone https://github.com/rbenv/rbenv.git ~/.rbenv
    cd ~/.rbenv && src/configure && make -C src

    echo "   * Install rbenv plugins..."
    mkdir -p ~/.rbenv/plugins
    git clone https://github.com/rbenv/ruby-build.git "$(rbenv root)"/plugins/ruby-build
  fi
}

function install_tmux() {
  echo " * Install tmux ..."

  if [ -d $HOME/.tmux/plugins/tpm ]; then
    cd ~/.tmux/plugins/tpm && git pull
  else
    mkdir -p ~/.tmux/plugins/tpm
    git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
  fi
}

install_pkgs
install_zim
install_rbenv
install_tmux
install_rcs
install_bin
