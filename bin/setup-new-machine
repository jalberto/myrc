#!/bin/bash
MYRC_DIR="$HOME/myrc/"

SYSTEM_PKGS="zsh fasd fzf git neovim ctags tmux byobu"
APPS_PKGS="meld gnome-tweaks"
DEV_PKGS="cmake make automake gcc gcc-c++ kernel-devel python-devel"

function backpath() {
  if [ -f $1 ] || [ -d $1 ]; then
    mv $1 $1.bak
  fi
}

function symlink() {
  backpath $2
  ln -sf $1 $2
}

function install_rcs() {
  echo " * Install RC files..."

  symlink $MYRC_DIR/gitconfig $HOME/.gitconfig
  symlink $MYRC_DIR/gitignore $HOME/.gitignore

  symlink $MYRC_DIR/zshrc $HOME/.zshrc
  symlink $MYRC_DIR/zimrc $HOME/.zimrc
  symlink $MYRC_DIR/zlogin $HOME/.zlogin

  symlink $MYRC_DIR/rails.rc $HOME/.rails.rc
  symlink $MYRC_DIR/pryrc $HOME/.pryrc
}

function install_bin() {
  echo " * Install Bin dir..."

  [ ! -e $HOME/bin ] && ln -sf $MYRC_DIR/bin $HOME/bin
  chmod +x $HOME/bin/*
}

function install_pkgs() {
  sudo dnf install -y ${SYSTEM_PKGS} ${APPS_PKGS} ${DEV_PKGS}
}

function install_zim() {
  if [ -d $HOME/.zim ]; then
    echo " * Update zsh fw Zim..."
    cd $HOME/.zim
    git pull
  else
    echo " * Install zsh fw Zim..."
    git clone --recursive https://github.com/zimfw/zimfw.git ${ZDOTDIR:-${HOME}}/.zim

    # setopt EXTENDED_GLOB
    # for template_file in ${ZDOTDIR:-${HOME}}/.zim/templates/*; do
    #   user_file="${ZDOTDIR:-${HOME}}/.${template_file:t}"
    #   touch ${user_file}
    #   ( print -rn "$(<${template_file})$(<${user_file})" >! ${user_file} ) 2>/dev/null
    # done

    symlink $MYRC_DIR/zlogin $HOME/.zlogin
    symlink $MYRC_DIR/zshrc $HOME/.zshrc
    symlink $MYRC_DIR/zimrc $HOME/.zimrc

    #chsh -s =zsh
    sudo usermod -s /bin/zsh ja
  fi
}

function install_rbenv() {
  if [ -d $HOME/.rbenv ]; then
    echo " * Update rbenv..."
    cd ~/.rbenv && git pull
    cd ~/.rbenv/plugins
    for p in `ls` ; do
      cd $p && git pull && cd ..
    done
  else
    echo " * Install rbenv..."
    git clone https://github.com/rbenv/rbenv.git ~/.rbenv
    cd ~/.rbenv && src/configure && make -C src

    echo "   * Install rbenv plugins..."
    mkdir -p ~/.rbenv/plugins
    git clone https://github.com/rbenv/ruby-build.git "$(rbenv root)"/plugins/ruby-build
  fi
}

function install_tmux() {
  echo " * Install tmux (byobu) ..."

  # mkdir -p ~/.tmux/plugins

  symlink $MYRC_DIR/byobu/tmux.conf ~/.byobu/.tmux.conf

  # if [ -d $HOME/.tmux/plugins/tpm ]; then
  #   cd ~/.tmux/plugins/tpm && git pull
  # else
  #   git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
  # fi
}

function install_flatpak() {
  flatpak remote-add flathub https://flathub.org/repo/flathub.flatpakrepo
  # flatpak remote-ls flathub | grep org.gtk.Gtk3theme
 flatpak install flathub org.gtk.Gtk3theme.Arc-Dark
}

function install_vim() {
  [ ! -d $HOME/.vim ] && git clone git://github.com/jalberto/bass-vim.git $HOME/.vim
  [ ! -e $HOME/.nvim ] && ln -s ~/.vim ~/.nvim
  [ ! -e $HOME/.vimrc ] && ln -s ~/.vim/vimrc ~/.vimrc
  mkdir -p $HOME/.config/nvim
  [ ! -e $HOME/.config/nvim/init.vim ] && ln -s ~/.vim/vimrc ~/.config/nvim/init.vim

  pip install --user neovim
  pip3 install --user neovim
}

function install_docker() {
  sudo dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo
  sudo dnf install docker-ce
}

if [ -z $1 ]; then
  install_flatpak
  install_pkgs
  install_zim
  install_rbenv
  install_tmux
  install_vim
  install_rcs
  install_bin
  install_docker
else
  $1
fi
